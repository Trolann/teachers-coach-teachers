{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Fake Mentor Data Generator</h2>
    
    <div class="alert alert-info">
        Current number of mentor profiles: <span id="mentorCount">{{ mentor_count }}</span>
        <span id="progressCounter" style="display: none;" class="alert-warning px-2 rounded"></span>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Generate Fake Mentors</h5>
            
            <form id="generateForm" onsubmit="handleSubmit(event)">
                <div class="mb-3">
                    <label for="numProfiles" class="form-label">Number of Profiles to Generate</label>
                    <input type="number" class="form-control" id="numProfiles" name="numProfiles" min="1" max="100" value="10">
                </div>

                <h6>Fields to Generate</h6>
                <div class="mb-3">
                    <ul class="list-group">
                        {% for field in profile_fields %}
                        <li class="list-group-item">{{ field }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary">Generate Profiles</button>
            </form>
        </div>
    </div>
</div>

<script>
async function updateMentorCount() {
    try {
        const response = await fetch('/admin/fake-mentors/count');
        const data = await response.json();
        if (data.success) {
            return data.count;
        }
        return null;
    } catch (error) {
        console.error('Error fetching mentor count:', error);
        return null;
    }
}

function showProgress(current, total) {
    const progressCounter = document.getElementById('progressCounter');
    const mentorCount = document.getElementById('mentorCount');
    
    progressCounter.textContent = `${current}/${total}`;
    progressCounter.style.display = 'inline';
    
    if (current === total) {
        // When complete, turn green
        progressCounter.classList.remove('alert-warning');
        progressCounter.classList.add('alert-success');
        setTimeout(() => {
            // After a delay, update the main count and hide the progress
            mentorCount.textContent = current + parseInt(mentorCount.textContent);
            progressCounter.style.display = 'none';
        }, 2000);
    }
}

let pollingInterval = null;

async function pollProgress(total) {
    try {
        const response = await fetch('/admin/fake-mentors/progress');
        const data = await response.json();
        
        if (data.success) {
            // Update progress display
            showProgress(data.current, total);
            
            // If generation is complete or there was an error, stop polling
            if (!data.in_progress || data.error) {
                if (data.error) {
                    alert('Error during profile generation: ' + data.error);
                }
                clearInterval(pollingInterval);
                pollingInterval = null;
                
                // Update the final count
                const countResponse = await fetch('/admin/fake-mentors/count');
                const countData = await countResponse.json();
                if (countData.success) {
                    document.getElementById('mentorCount').textContent = countData.count;
                }
                
                // Re-enable the submit button
                document.querySelector('#generateForm button[type="submit"]').disabled = false;
            }
        }
    } catch (error) {
        console.error('Error polling progress:', error);
        clearInterval(pollingInterval);
        pollingInterval = null;
        document.querySelector('#generateForm button[type="submit"]').disabled = false;
    }
}

async function handleSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    
    try {
        const formData = new FormData(form);
        const numProfiles = parseInt(document.getElementById('numProfiles').value);
        formData.set('numProfiles', numProfiles);
        
        // Show initial progress
        showProgress(0, numProfiles);
        
        const response = await fetch('/admin/fake-mentors/generate', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            // Start polling for progress updates
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            pollingInterval = setInterval(() => pollProgress(numProfiles), 500);
        } else {
            alert('Error starting profile generation: ' + data.error);
            document.getElementById('progressCounter').style.display = 'none';
            submitButton.disabled = false;
        }
    } catch (error) {
        alert('Error: ' + error);
        document.getElementById('progressCounter').style.display = 'none';
        submitButton.disabled = false;
    }
}
</script>
{% endblock %}
