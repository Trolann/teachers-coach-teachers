{% extends "base.html" %}

{% block title %}Logs{% endblock %}

{% block content %}
<style>
    .log-viewer {
        background-color: #2b2b2b;
        color: #f0f0f0;
        font-family: 'Consolas', 'Monaco', monospace;
        padding: 15px;
        border-radius: 5px;
        height: 800px;
        overflow-y: auto;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }
    .log-line {
        white-space: pre-wrap;
        margin: 3px 0;
        padding: 3px 8px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }
    .log-line:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .log-DEBUG { color: #88c0d0; }
    .log-INFO { color: #a3be8c; }
    .log-WARNING { color: #ebcb8b; }
    .log-ERROR { color: #bf616a; }
    .log-CRITICAL { 
        color: #ffffff;
        background-color: #bf616a;
        font-weight: bold;
    }
    .stack-trace {
        color: #ce9178;
        margin-left: 20px;
    }
    .log-controls {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .filter-controls {
        margin-left: auto;
    }
</style>

<div class="log-controls">
    <select id="logFile" class="form-select" style="width: auto;" onchange="changeLog(this.value)">
        {% for file, timestamp in log_files %}
        <option value="{{ file }}" {% if file == selected_log %}selected{% endif %}>
            {{ file }} ({{ timestamp }})
        </option>
        {% endfor %}
    </select>

    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="tailMode" {% if tail_mode %}checked{% endif %} 
               onchange="toggleTail(this.checked)">
        <label class="form-check-label" for="tailMode">Tail Mode</label>
    </div>

    <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">ðŸ”„ Refresh</button>
    
    <div class="filter-controls">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary active" data-level="all">All</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-level="DEBUG">Debug</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-level="INFO">Info</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-level="WARNING">Warning</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-level="ERROR">Error</button>
        </div>
    </div>
</div>

<div id="logViewer" class="log-viewer" data-content='{{ current_log | tojson }}'></div>

<script>
let currentFilter = 'all';

function formatLogLine(logEntry) {
    if (!logEntry.content) return '';
    
    // Check if line is part of a stack trace
    if (logEntry.content.startsWith(' ') || logEntry.content.startsWith('\t')) {
        return `<div class="log-line stack-trace">${logEntry.content}</div>`;
    }
    
    const level = logEntry.level || '';
    const timestamp = logEntry.content.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);
    const timeStr = timestamp ? timestamp[0] : '';
    
    return `
        <div class="log-line log-${level}" data-level="${level}">
            <span style="color: #666;">${timeStr}</span> 
            ${logEntry.content.substring(timeStr.length)}
        </div>
    `;
}

function updateLogView(content) {
    const logViewer = document.getElementById('logViewer');
    logViewer.innerHTML = content.map(formatLogLine).join('');
    
    // Apply current filter
    filterLogs(currentFilter);
    
    // Scroll to bottom if in tail mode
    if (document.getElementById('tailMode').checked) {
        logViewer.scrollTop = logViewer.scrollHeight;
    }
}

function filterLogs(level) {
    currentFilter = level;
    const lines = document.querySelectorAll('.log-line');
    
    lines.forEach(line => {
        if (level === 'all' || line.dataset.level === level) {
            line.style.display = '';
        } else {
            line.style.display = 'none';
        }
    });
}

// Initial load
updateLogView({{ current_log | tojson }});

function refreshLogs() {
    const currentFile = document.getElementById('logFile').value;
    const tailMode = document.getElementById('tailMode').checked;
    
    // Use fetch to get updated logs without full page reload
    fetch(`?file=${currentFile}&tail=${tailMode}`)
        .then(response => response.text())
        .then(html => {
            // Extract log content from the response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContent = JSON.parse(doc.getElementById('logViewer').getAttribute('data-content'));
            updateLogView(newContent);
        });
}

function changeLog(filename) {
    const tailMode = document.getElementById('tailMode').checked;
    window.location.href = `?file=${filename}&tail=${tailMode}`;
}

let refreshInterval;

function toggleTail(enabled) {
    const currentFile = document.getElementById('logFile').value;
    window.location.href = `?file=${currentFile}&tail=${enabled}`;
    
    if (enabled) {
        // Start auto-refresh when tail mode is enabled
        refreshInterval = setInterval(refreshLogs, 5000); // Refresh every 5 seconds
    } else {
        // Clear auto-refresh when tail mode is disabled
        clearInterval(refreshInterval);
    }
}

// Set up initial auto-refresh if tail mode is enabled
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('tailMode').checked) {
        refreshInterval = setInterval(refreshLogs, 5000);
    }
});

document.querySelectorAll('[data-level]').forEach(button => {
    button.addEventListener('click', (e) => {
        // Update button states
        document.querySelectorAll('[data-level]').forEach(btn => {
            btn.classList.remove('active');
        });
        e.target.classList.add('active');
        
        // Apply filter
        filterLogs(e.target.dataset.level);
    });
});
</script>
{% endblock %}
