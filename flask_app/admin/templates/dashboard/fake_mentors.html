{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Fake Mentor Data Generator</h2>
    
    <div class="alert alert-info">
        Current number of mentor profiles: <span id="mentorCount">{{ mentor_count }}</span>
        <span id="progressCounter" style="display: none;" class="alert-warning px-2 rounded"></span>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Generate Fake Mentors</h5>
            
            <form id="generateForm" onsubmit="handleSubmit(event)">
                <div class="mb-3">
                    <label for="numProfiles" class="form-label">Number of Profiles to Generate</label>
                    <input type="number" class="form-control" id="numProfiles" name="numProfiles" min="1" max="100" value="10">
                </div>

                <h6>Fields to Generate</h6>
                <div class="mb-3">
                    <ul class="list-group">
                        {% for field in profile_fields %}
                        <li class="list-group-item">{{ field }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary">Generate Profiles</button>
            </form>
        </div>
    </div>
</div>

<script>
async function updateMentorCount() {
    try {
        const response = await fetch('/admin/fake-mentors/count');
        const data = await response.json();
        if (data.success) {
            return data.count;
        }
        return null;
    } catch (error) {
        console.error('Error fetching mentor count:', error);
        return null;
    }
}

function showProgress(current, total) {
    const progressCounter = document.getElementById('progressCounter');
    const mentorCount = document.getElementById('mentorCount');
    
    progressCounter.textContent = `${current}/${total}`;
    progressCounter.style.display = 'inline';
    
    if (current === total) {
        // When complete, turn green
        progressCounter.classList.remove('alert-warning');
        progressCounter.classList.add('alert-success');
        setTimeout(() => {
            // After a delay, update the main count and hide the progress
            mentorCount.textContent = total;
            progressCounter.style.display = 'none';
        }, 2000);
    }
}

async function handleSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    
    try {
        const formData = new FormData(form);
        const numProfiles = parseInt(document.getElementById('numProfiles').value);
        formData.set('numProfiles', numProfiles);
        
        // Get initial count
        const initialCount = await updateMentorCount();
        let currentCount = initialCount;
        
        // Show initial progress
        showProgress(0, numProfiles);
        
        const response = await fetch('/admin/fake-mentors/generate', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            // Update to show completion
            showProgress(numProfiles, numProfiles);
        } else {
            alert('Error generating profiles: ' + data.error);
            // Hide progress counter on error
            document.getElementById('progressCounter').style.display = 'none';
        }
    } catch (error) {
        alert('Error: ' + error);
        // Hide progress counter on error
        document.getElementById('progressCounter').style.display = 'none';
    } finally {
        submitButton.disabled = false;
    }
}
</script>
{% endblock %}
