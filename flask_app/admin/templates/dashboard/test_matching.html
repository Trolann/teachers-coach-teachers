{% extends "base.html" %}

{% block title %}AI Matching Test Panel{% endblock %}

{% block content %}
    <style>
        .card {
            margin-bottom: 20px;
        }

        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .json-key {
            color: #7d3c98;
        }

        .json-string {
            color: #2e86c1;
        }

        .json-number {
            color: #e67e22;
        }

        .json-boolean {
            color: #c0392b;
        }

        .json-null {
            color: #95a5a6;
        }

        .nav-tabs {
            margin-bottom: 20px;
        }

        .tab-content {
            padding-top: 10px;
        }

        .json-property {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .json-property-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .json-property-value {
            width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 200px;
        }

        textarea.json-property-value {
            min-height: 80px;
        }
    </style>

    <div class="container-fluid">
        <h1>AI Matching Test Panel</h1>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="matchingTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="results-tab" data-bs-toggle="tab" data-bs-target="#results"
                        type="button" role="tab" aria-controls="results" aria-selected="true">Results
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="test-matching-tab" data-bs-toggle="tab" data-bs-target="#test-matching"
                        type="button" role="tab" aria-controls="test-matching" aria-selected="false">Test Matching
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="human-testing-tab" data-bs-toggle="tab" data-bs-target="#human-testing"
                        type="button" role="tab" aria-controls="human-testing" aria-selected="false">Human Testing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="run-tests-tab" data-bs-toggle="tab" data-bs-target="#run-tests"
                        type="button" role="tab" aria-controls="run-tests" aria-selected="false">Run Automated Tests
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="matchingTabsContent">
            <!-- Results Tab (Default) -->
            <div class="tab-pane fade show active" id="results" role="tabpanel" aria-labelledby="results-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>Human Testing Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="humanTestResults">
                            <p class="text-muted">Loading human test results...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Matching Tab -->
            <div class="tab-pane fade" id="test-matching" role="tabpanel" aria-labelledby="test-matching-tab">
                <div class="row">
                    <!-- Test Matching -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Matching Algorithm</h5>
                            </div>
                            <div class="card-body">
                                <form id="matchingForm">
                                    <div class="mb-3">
                                        <label for="userId" class="form-label">Requester User ID (optional)</label>
                                        <input type="text" class="form-control" id="userId" name="user_id"
                                               placeholder="Leave blank to generate a temporary ID">
                                        <div class="form-text">The user ID to use as the requester for matching</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="searchCriteria" class="form-label">Search Criteria (JSON)</label>
                                        <textarea class="form-control" id="searchCriteria" name="search_criteria"
                                                  rows="5"
                                                  placeholder='{"bio": "I need help with educational leadership", "expertise": "curriculum development"}'></textarea>
                                        <div class="form-text">Enter a JSON object with search criteria</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="limit" class="form-label">Result Limit</label>
                                        <input type="number" class="form-control" id="limit" name="limit" min="1"
                                               max="50" value="10">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Test Matching</button>
                                </form>
                            </div>
                        </div>

                        <!-- Matching Results -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Matching Results</h5>
                            </div>
                            <div class="card-body">
                                <div id="matchingResults">
                                    <p class="text-muted">Run a matching test to see results here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Human Testing Tab -->
            <div class="tab-pane fade" id="human-testing" role="tabpanel" aria-labelledby="human-testing-tab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Human Testing Interface</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="menteeSelect" class="form-label">Database Mentees</label>
                                            <select class="form-select" id="menteeSelect">
                                                <option value="">Loading mentees...</option>
                                            </select>
                                            <div class="form-text">Select a mentee profile from the database</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="queryFileSelect" class="form-label">JSON File</label>
                                            <select class="form-select" id="queryFileSelect">
                                                <option value="">Loading files...</option>
                                            </select>
                                            <div class="form-text">Select a JSON file containing mentee queries</div>
                                        </div>
                                        <div class="mb-3" id="jsonMenteeWrapper" style="display: none;">
                                            <label for="jsonMenteeSelect" class="form-label">JSON Mentees</label>
                                            <select class="form-select" id="jsonMenteeSelect">
                                                <option value="">Select a mentee from JSON</option>
                                            </select>
                                            <div class="form-text">Select a mentee profile from the JSON file</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">Query Configuration</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="queryEditor" class="form-label">Edit Query</label>
                                            <div id="queryEditor" class="border rounded p-2"
                                                 style="min-height: 300px;"></div>
                                            <div class="form-text">Edit the query parameters as needed</div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="goalQuery" class="form-label">Goal <span
                                                    class="text-danger">*</span></label>
                                            <textarea class="form-control" id="goalQuery" rows="3"
                                                      placeholder="I'm looking for a mentor who..." required></textarea>
                                            <div class="form-text">Describe what you're looking for in a mentor
                                                (required)
                                            </div>
                                        </div>

                                        <button id="findMentorsBtn" class="btn btn-primary">Find Mentors</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Human Testing Results -->
                        <div id="humanTestingResults" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Mentor Matches</h5>
                                    <p class="text-muted mb-0">Rate each match as "Good Match" or "Bad Match"</p>
                                </div>
                                <div class="card-body">
                                    <div id="mentorMatches">
                                        <!-- Mentor matches will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Run Automated Tests Tab -->
            <div class="tab-pane fade" id="run-tests" role="tabpanel" aria-labelledby="run-tests-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>Run Automated Tests</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="serverFileSelect" class="form-label">Select Server File</label>
                            <select class="form-select" id="serverFileSelect">
                                <option value="">Loading files...</option>
                            </select>
                            <div class="form-text">Select a JSON file from the server</div>
                        </div>
                        <button id="runServerFileTest" class="btn btn-primary" disabled>Run Tests</button>

                        <div id="testResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CSS for mentor cards in human testing
        const mentorCardStyles = `
            .mentor-card {
                border: 1px solid #ddd;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                overflow: hidden;
            }
            .mentor-card-header {
                background-color: #f8f9fa;
                padding: 15px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .mentor-card-body {
                padding: 15px;
            }
            .mentor-card-footer {
                padding: 15px;
                background-color: #f8f9fa;
                border-top: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
            }
            .mentor-info {
                margin-bottom: 15px;
            }
            .mentor-details-toggle {
                cursor: pointer;
                color: #0d6efd;
                text-decoration: underline;
            }
            .mentor-details {
                display: none;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px dashed #ddd;
            }
            .feedback-btn {
                flex: 1;
                margin: 0 5px;
            }
            #queryEditor {
                font-family: monospace;
                overflow-y: auto;
            }
            .json-property {
                margin-bottom: 8px;
            }
            .json-property-name {
                font-weight: bold;
                margin-right: 5px;
            }
            .json-property-value {
                width: 100%;
            }
        `;

        // Add styles to head
        const styleElement = document.createElement('style');
        styleElement.textContent = mentorCardStyles;
        document.head.appendChild(styleElement);
        // Check if Bootstrap is available
        if (typeof bootstrap === 'undefined') {
            console.error("Bootstrap JavaScript is not loaded. Tab functionality may not work properly.");
            // Add a simple fallback for tab switching
            document.addEventListener('DOMContentLoaded', function () {
                const tabButtons = document.querySelectorAll('.nav-tabs button');
                const tabPanes = document.querySelectorAll('.tab-pane');

                tabButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        // Remove active class from all buttons and panes
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabPanes.forEach(pane => {
                            pane.classList.remove('active');
                            pane.classList.remove('show');
                        });

                        // Add active class to clicked button
                        this.classList.add('active');

                        // Get target pane and activate it
                        const target = this.getAttribute('data-bs-target');
                        const targetPane = document.querySelector(target);
                        if (targetPane) {
                            targetPane.classList.add('active');
                            targetPane.classList.add('show');
                        }
                    });
                });
            });
        }

        // Format JSON with syntax highlighting
        function syntaxHighlight(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Switch to specific tab when needed
        function switchToTab(tabId) {
            const tab = document.getElementById(tabId);
            if (tab) {
                try {
                    const tabTrigger = new bootstrap.Tab(tab);
                    tabTrigger.show();
                } catch (error) {
                    console.error("Error switching tabs:", error);
                    // Fallback method if bootstrap.Tab fails
                    tab.click();
                }
            }
        }

        // Test Matching Form
        document.getElementById('matchingForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch('/admin/test-matching/test', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    let resultHtml = '';
                    if (data.success) {
                        resultHtml = `
                        <div class="alert alert-success">Found ${data.total} matches for requester ID: ${data.requester_id}</div>
                        <h6>Search Criteria:</h6>
                        <pre>${syntaxHighlight(data.criteria)}</pre>
                        <h6>Matches:</h6>
                    `;

                        if (data.matches.length > 0) {
                            data.matches.forEach((match, index) => {
                                resultHtml += `
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <strong>Match #${index + 1}</strong> - Score: ${match.score.toFixed(2)}
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Name:</strong> ${match.profile.formattedName || `${match.profile.firstName} ${match.profile.lastName}`}</p>
                                                <p><strong>Email:</strong> ${match.email}</p>
                                                <p><strong>Location:</strong> ${match.profile.stateProvince || ''}, ${match.profile.country || ''}</p>
                                                <p><strong>School District:</strong> ${match.profile.schoolDistrict || 'N/A'}</p>
                                                <p><strong>Primary Subject:</strong> ${match.profile.primarySubject || 'N/A'}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>User ID:</strong> ${match.user_id}</p>
                                                <p><strong>Matched on:</strong> ${match.matched_on.join(', ')}</p>
                                                <p><strong>Phone:</strong> ${match.profile.phoneNumber || 'N/A'}</p>
                                                <p><strong>Time Zone:</strong> ${match.profile.timeZone || 'N/A'}</p>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6>Mentor Skills:</h6>
                                            <p>${match.profile.mentorSkills || 'No skills information available'}</p>
                                        </div>
                                        <div class="mt-3">
                                            <h6>Full Profile:</h6>
                                            <pre>${syntaxHighlight(match.profile)}</pre>
                                        </div>
                                    </div>
                                </div>
                            `;
                            });
                        } else {
                            resultHtml += '<div class="alert alert-warning">No matches found</div>';
                        }
                    } else {
                        resultHtml = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    }
                    document.getElementById('matchingResults').innerHTML = resultHtml;
                })
                .catch(error => {
                    document.getElementById('matchingResults').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        });

        // This function has been moved and improved above

        // Function to load server files for a specific select element
        function loadServerFiles(selectElementId = 'serverFileSelect') {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;

            fetch('/admin/test-matching/get-json-files')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selectElement.innerHTML = '';

                        if (data.files.length === 0) {
                            selectElement.innerHTML = '<option value="">No files available</option>';
                            if (selectElementId === 'serverFileSelect') {
                                document.getElementById('runServerFileTest').disabled = true;
                            }
                        } else {
                            selectElement.innerHTML = '<option value="">Select a file</option>';
                            data.files.forEach(file => {
                                const option = document.createElement('option');
                                option.value = file;
                                option.textContent = file;
                                selectElement.appendChild(option);
                            });

                            // Enable button when a file is selected (for server file test tab)
                            if (selectElementId === 'serverFileSelect') {
                                selectElement.addEventListener('change', function () {
                                    document.getElementById('runServerFileTest').disabled = !this.value;
                                });
                            }

                            // Add event listener for query file select to load queries
                            if (selectElementId === 'queryFileSelect') {
                                selectElement.addEventListener('change', function () {
                                    if (this.value) {
                                        loadQueries(this.value);
                                    } else {
                                        // Hide JSON mentee wrapper if no file selected
                                        document.getElementById('jsonMenteeWrapper').style.display = 'none';
                                    }
                                });
                            }
                        }
                    } else {
                        selectElement.innerHTML = '<option value="">Error loading files</option>';
                        console.error('Error loading server files:', data.error);
                    }
                })
                .catch(error => {
                    selectElement.innerHTML = '<option value="">Error loading files</option>';
                    console.error('Error loading server files:', error);
                });
        }

        // Load server files when the Run Automated Tests tab is shown
        document.getElementById('run-tests-tab').addEventListener('shown.bs.tab', function () {
            loadServerFiles('serverFileSelect');
        });

        // Also load server files on page load if we're on the Run Automated Tests tab
        document.addEventListener('DOMContentLoaded', function () {
            if (window.location.hash === '#run-tests') {
                loadServerFiles('serverFileSelect');
            }

            // Load human test results on page load
            loadHumanTestResults();

            // Load mentees when the Human Testing tab is shown
            document.getElementById('human-testing-tab').addEventListener('shown.bs.tab', function () {
                loadMentees();
                loadServerFiles('queryFileSelect');

                // Initialize an empty query editor
                const queryEditor = document.getElementById('queryEditor');
                queryEditor.innerHTML = '<div class="alert alert-info">Select a mentee to load query fields</div>';
            });

            // Also load files for Human Testing tab if that's the active tab on page load
            if (window.location.hash === '#human-testing') {
                loadMentees();
                loadServerFiles('queryFileSelect');
            }
        });


        // Function to display test results
        function displayTestResults(data, testResultsDiv) {
            if (data.success) {
                const results = data.results;
                const summary = results.summary;
                const details = results.detailed_results;

                let resultHtml = `
                    <div class="alert alert-${summary.pass_rate >= 70 ? 'success' : 'warning'}">
                        Test Results: ${summary.passed}/${summary.total} passed (${summary.pass_rate.toFixed(2)}%)
                    </div>
                    <h6>Detailed Results:</h6>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Query Name</th>
                                <th>Target Mentor</th>
                                <th>Rank</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                details.forEach(result => {
                    resultHtml += `
                        <tr>
                            <td>${result.query_index + 1}</td>
                            <td>${result.query_name}</td>
                            <td>${result.target_mentor_name}</td>
                            <td>${result.target_rank || 'Not found'}</td>
                            <td>
                                <span class="badge bg-${result.passed ? 'success' : (result.error ? 'warning' : 'danger')}">
                                    ${result.passed ? 'PASS' : (result.error ? 'ERROR' : 'FAIL')}
                                </span>
                                ${result.error ? `<div class="small text-danger mt-1">${result.error}</div>` : ''}
                            </td>
                        </tr>
                    `;
                });

                resultHtml += `
                        </tbody>
                    </table>
                `;

                if (data.resultFile) {
                    resultHtml += `
                        <div class="alert alert-info mt-3">
                            Results saved to: ${data.resultFile}
                        </div>
                    `;
                }

                testResultsDiv.innerHTML = resultHtml;
            } else {
                testResultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            }
        }

        // Run tests with server file
        document.getElementById('runServerFileTest').addEventListener('click', function () {
            const serverFileSelect = document.getElementById('serverFileSelect');
            const selectedFile = serverFileSelect.value;
            const testResultsDiv = document.getElementById('testResults');

            if (!selectedFile) {
                testResultsDiv.innerHTML = '<div class="alert alert-danger">Please select a file</div>';
                return;
            }

            testResultsDiv.innerHTML = '<div class="alert alert-info">Running tests, please wait...</div>';

            fetch('/admin/test-matching/run-server-file-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({filename: selectedFile})
            })
                .then(response => response.json())
                .then(data => {
                    displayTestResults(data, testResultsDiv);
                })
                .catch(error => {
                    testResultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        });

        // Handle tab navigation via URL hash
        function handleTabNavigation() {
            const hash = window.location.hash;
            if (hash) {
                const tabId = hash.replace('#', '') + '-tab';
                switchToTab(tabId);
            }
        }

        // Initialize tabs and handle navigation
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Bootstrap tabs
            const tabElements = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabElements.forEach(tabEl => {
                new bootstrap.Tab(tabEl);

                tabEl.addEventListener('shown.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('data-bs-target').replace('#', '');
                    window.location.hash = targetId;
                });
            });

            // Handle initial tab navigation
            handleTabNavigation();
        });

        // Handle back/forward browser navigation
        window.addEventListener('hashchange', handleTabNavigation);

        // Create editable JSON editor dynamically based on the mentee profile
        function createJsonEditor(container, jsonData) {
            container.innerHTML = '';

            // Skip these fields that shouldn't be editable
            const skipFields = ['targetMentorId', 'id', 'userId', 'cognito_sub', 'email'];

            // Create form elements for each property
            Object.keys(jsonData).forEach(key => {
                if (skipFields.includes(key)) return;

                const value = jsonData[key];
                const propertyDiv = document.createElement('div');
                propertyDiv.className = 'json-property';

                const label = document.createElement('label');
                label.className = 'json-property-name';
                label.textContent = key + ':';
                propertyDiv.appendChild(label);

                let input;

                if (typeof value === 'boolean') {
                    // Create a select for boolean values
                    input = document.createElement('select');
                    input.className = 'form-select json-property-value';

                    const trueOption = document.createElement('option');
                    trueOption.value = 'true';
                    trueOption.textContent = 'true';
                    trueOption.selected = value === true;

                    const falseOption = document.createElement('option');
                    falseOption.value = 'false';
                    falseOption.textContent = 'false';
                    falseOption.selected = value === false;

                    input.appendChild(trueOption);
                    input.appendChild(falseOption);
                } else if (typeof value === 'number') {
                    // Create a number input
                    input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control json-property-value';
                    input.value = value;
                } else if (Array.isArray(value)) {
                    // Create a textarea for arrays
                    input = document.createElement('textarea');
                    input.className = 'form-control json-property-value';
                    input.value = JSON.stringify(value);
                    input.rows = 3;
                } else if (typeof value === 'object' && value !== null) {
                    // Create a textarea for objects
                    input = document.createElement('textarea');
                    input.className = 'form-control json-property-value';
                    input.value = JSON.stringify(value, null, 2);
                    input.rows = 4;
                } else {
                    // Create a text input for strings and other values
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control json-property-value';
                    input.value = value !== null ? value : '';
                }

                input.setAttribute('data-key', key);
                propertyDiv.appendChild(input);
                container.appendChild(propertyDiv);
            });

            // Add a button to add new properties
            const addPropertyDiv = document.createElement('div');
            addPropertyDiv.className = 'mt-3';

            const addPropertyBtn = document.createElement('button');
            addPropertyBtn.type = 'button';
            addPropertyBtn.className = 'btn btn-sm btn-outline-primary';
            addPropertyBtn.textContent = 'Add Property';
            addPropertyBtn.onclick = function () {
                const key = prompt('Enter property name:');
                if (key && key.trim()) {
                    const propertyDiv = document.createElement('div');
                    propertyDiv.className = 'json-property';

                    const label = document.createElement('label');
                    label.className = 'json-property-name';
                    label.textContent = key.trim() + ':';
                    propertyDiv.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control json-property-value';
                    input.setAttribute('data-key', key.trim());
                    propertyDiv.appendChild(input);

                    container.insertBefore(propertyDiv, addPropertyDiv);
                }
            };

            addPropertyDiv.appendChild(addPropertyBtn);
            
            // Add Save Mentee button only for JSON mentees
            const jsonMenteeSelect = document.getElementById('jsonMenteeSelect');
            if (jsonMenteeSelect && jsonMenteeSelect.value) {
                const saveMenteeBtn = document.createElement('button');
                saveMenteeBtn.type = 'button';
                saveMenteeBtn.className = 'btn btn-sm btn-outline-success ms-2';
                saveMenteeBtn.textContent = 'Save Mentee';
                saveMenteeBtn.onclick = function() {
                    saveMenteeProfile(container);
                };
                
                addPropertyDiv.appendChild(saveMenteeBtn);
            }
            container.appendChild(addPropertyDiv);
        }

        // Get JSON data from editor
        function getJsonFromEditor(container) {
            const result = {};

            // Get all inputs
            const inputs = container.querySelectorAll('.json-property-value');
            inputs.forEach(input => {
                const key = input.getAttribute('data-key');
                let value = input.value;

                // Try to parse the value
                try {
                    if (input.tagName === 'SELECT' && (value === 'true' || value === 'false')) {
                        // Handle boolean values
                        value = value === 'true';
                    } else if (!isNaN(value) && value.trim() !== '') {
                        // Handle numeric values
                        value = Number(value);
                    } else if (value.startsWith('[') || value.startsWith('{')) {
                        // Handle arrays and objects
                        value = JSON.parse(value);
                    }
                } catch (e) {
                    // If parsing fails, keep as string
                    console.warn(`Failed to parse value for ${key}:`, e);
                }

                result[key] = value;
            });

            return result;
        }
        
        // Save mentee profile
        function saveMenteeProfile(container) {
            // Get the current profile data from the editor
            const profileData = getJsonFromEditor(container);
            
            // Get JSON file and mentee information
            const jsonMenteeSelect = document.getElementById('jsonMenteeSelect');
            const queryFileSelect = document.getElementById('queryFileSelect');
            
            if (!jsonMenteeSelect.value || !queryFileSelect.value) {
                alert('Please select a valid mentee from the JSON file');
                return;
            }
            
            const fileName = queryFileSelect.value;
            
            // Get the selected mentee index from the JSON file
            const selectedIndex = jsonMenteeSelect.selectedIndex - 1; // -1 because of the placeholder option
            if (selectedIndex < 0) {
                alert('Please select a valid mentee from the JSON file');
                return;
            }
            
            console.log('Saving mentee profile:', {
                fileName,
                selectedIndex,
                profileDataKeys: Object.keys(profileData)
            });
            
            // Show loading state
            const saveBtn = Array.from(container.querySelectorAll('button')).find(btn => btn.textContent === 'Save Mentee');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            // Call the API to save the profile
            fetch('/admin/test-matching/save-mentee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    saveType: 'file',
                    fileName: fileName,
                    selectedIndex: selectedIndex,
                    profileData: profileData
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Save response:', data);
                if (data.success) {
                    // Show success message
                    alert('Mentee profile saved successfully!');
                } else {
                    // Show error message
                    alert('Error saving mentee profile: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving mentee profile:', error);
                alert('Error saving mentee profile: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
        }

        // Load mentees for human testing
        function loadMentees() {
            const menteeSelect = document.getElementById('menteeSelect');

            fetch('/admin/test-matching/get-mentees')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        menteeSelect.innerHTML = '';

                        if (data.mentees.length === 0) {
                            menteeSelect.innerHTML = '<option value="">No mentees available</option>';
                        } else {
                            menteeSelect.innerHTML = '<option value="">Select a mentee</option>';
                            data.mentees.forEach(mentee => {
                                const option = document.createElement('option');
                                option.value = mentee.id;
                                option.setAttribute('data-name', mentee.name);
                                option.setAttribute('data-profile', JSON.stringify(mentee.profile));
                                option.textContent = `${mentee.name} (${mentee.email})`;
                                menteeSelect.appendChild(option);
                            });

                            // Add event listener to load profile into query editor
                            menteeSelect.addEventListener('change', function () {
                                if (this.value) {
                                    // Clear the JSON mentee selection when a database mentee is selected
                                    const jsonMenteeSelect = document.getElementById('jsonMenteeSelect');
                                    if (jsonMenteeSelect) {
                                        jsonMenteeSelect.value = '';
                                    }

                                    const selectedOption = this.options[this.selectedIndex];
                                    const profileData = JSON.parse(selectedOption.getAttribute('data-profile'));

                                    // Load the actual profile data into the editor
                                    const queryEditor = document.getElementById('queryEditor');
                                    createJsonEditor(queryEditor, profileData);
                                    
                                    // Remove Save button if it exists (since we're now showing a database mentee)
                                    const addPropertyDiv = queryEditor.querySelector('div.mt-3');
                                    if (addPropertyDiv) {
                                        const saveBtn = Array.from(addPropertyDiv.querySelectorAll('button')).find(btn => 
                                            btn.textContent === 'Save Mentee');
                                        
                                        if (saveBtn) {
                                            saveBtn.remove();
                                        }
                                    }
                                }
                            });
                        }
                    } else {
                        menteeSelect.innerHTML = '<option value="">Error loading mentees</option>';
                        console.error('Error loading mentees:', data.error);
                    }
                })
                .catch(error => {
                    menteeSelect.innerHTML = '<option value="">Error loading mentees</option>';
                    console.error('Error loading mentees:', error);
                });
        }

        // Load queries from selected file
        function loadQueries(filename) {
            const jsonMenteeSelect = document.getElementById('jsonMenteeSelect');
            const jsonMenteeWrapper = document.getElementById('jsonMenteeWrapper');

            fetch('/admin/test-matching/get-queries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({filename: filename})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        jsonMenteeSelect.innerHTML = '';

                        if (data.queries.length === 0) {
                            jsonMenteeSelect.innerHTML = '<option value="">No mentees available in file</option>';
                            jsonMenteeWrapper.style.display = 'none';
                        } else {
                            jsonMenteeSelect.innerHTML = '<option value="">Select a mentee from JSON</option>';
                            data.queries.forEach(query => {
                                const option = document.createElement('option');
                                option.value = JSON.stringify(query.data);
                                option.textContent = query.name;
                                jsonMenteeSelect.appendChild(option);
                            });

                            // Show JSON mentee selection container
                            jsonMenteeWrapper.style.display = 'block';

                            // Load query into editor when selected
                            jsonMenteeSelect.addEventListener('change', function () {
                                if (this.value) {
                                    // Clear the database mentee selection when a JSON mentee is selected
                                    const menteeSelect = document.getElementById('menteeSelect');
                                    if (menteeSelect) {
                                        menteeSelect.value = '';
                                    }

                                    try {
                                        const queryData = JSON.parse(this.value);
                                        const queryEditor = document.getElementById('queryEditor');
                                        createJsonEditor(queryEditor, queryData);
                                        
                                        // Add Save button if not already present
                                        const addPropertyDiv = queryEditor.querySelector('div.mt-3');
                                        if (addPropertyDiv) {
                                            // Check if Save button already exists
                                            const existingSaveBtn = Array.from(addPropertyDiv.querySelectorAll('button')).find(btn => 
                                                btn.textContent === 'Save Mentee');
                                            
                                            if (!existingSaveBtn) {
                                                const saveMenteeBtn = document.createElement('button');
                                                saveMenteeBtn.type = 'button';
                                                saveMenteeBtn.className = 'btn btn-sm btn-outline-success ms-2';
                                                saveMenteeBtn.textContent = 'Save Mentee';
                                                saveMenteeBtn.onclick = function() {
                                                    saveMenteeProfile(queryEditor);
                                                };
                                                
                                                addPropertyDiv.appendChild(saveMenteeBtn);
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Error parsing query data:', e);
                                    }
                                }
                            });
                        }
                    } else {
                        jsonMenteeSelect.innerHTML = '<option value="">Error loading mentees from file</option>';
                        jsonMenteeWrapper.style.display = 'none';
                        console.error('Error loading queries:', data.error);
                    }
                })
                .catch(error => {
                    jsonMenteeSelect.innerHTML = '<option value="">Error loading mentees from file</option>';
                    jsonMenteeWrapper.style.display = 'none';
                    console.error('Error loading queries:', error);
                });
        }

        // Find mentors button click handler
        document.getElementById('findMentorsBtn').addEventListener('click', function () {
            const menteeSelect = document.getElementById('menteeSelect');
            const jsonMenteeSelect = document.getElementById('jsonMenteeSelect');
            const goalQuery = document.getElementById('goalQuery');
            const mentorMatches = document.getElementById('mentorMatches');
            const humanTestingResults = document.getElementById('humanTestingResults');
            const queryEditor = document.getElementById('queryEditor');

            let menteeId, menteeName, queryData;

            // Check if goal is provided (required)
            if (!goalQuery.value.trim()) {
                alert('Please enter a goal for your mentor search');
                goalQuery.focus();
                return;
            }

            // Determine which mentee is selected
            if (menteeSelect.value) {
                // Database mentee is selected
                menteeId = menteeSelect.value;
                menteeName = menteeSelect.options[menteeSelect.selectedIndex].getAttribute('data-name');

                // Get query data from editor
                try {
                    queryData = getJsonFromEditor(queryEditor);
                } catch (e) {
                    alert('Error getting query data from editor: ' + e.message);
                    return;
                }
            } else if (jsonMenteeSelect.value) {
                // JSON mentee is selected
                // For JSON queries, we'll use a temporary ID
                menteeId = 'temp-' + Date.now();

                // Try to get a name from the query data
                try {
                    const selectedQueryData = JSON.parse(jsonMenteeSelect.value);
                    menteeName = selectedQueryData.firstName && selectedQueryData.lastName ?
                        `${selectedQueryData.firstName} ${selectedQueryData.lastName}` :
                        'JSON Query User';

                    // Get query data from editor
                    queryData = getJsonFromEditor(queryEditor);
                } catch (e) {
                    alert('Error parsing query data: ' + e.message);
                    return;
                }
            } else {
                alert('Please select a mentee from either the database or a JSON file');
                return;
            }

            // Add goal query (required)
            queryData.goal = goalQuery.value.trim();

            // Show loading state
            mentorMatches.innerHTML = '<div class="alert alert-info">Finding mentors, please wait...</div>';
            humanTestingResults.style.display = 'block';

            // Call the matching API
            const formData = new FormData();
            formData.append('user_id', menteeId);
            formData.append('search_criteria', JSON.stringify(queryData));
            formData.append('limit', '10');

            fetch('/admin/test-matching/test', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.matches.length === 0) {
                            mentorMatches.innerHTML = '<div class="alert alert-warning">No matches found</div>';
                            return;
                        }

                        // Display mentor matches
                        let matchesHtml = '';
                        data.matches.forEach((match, index) => {
                            const mentorName = match.profile.formattedName || `${match.profile.firstName} ${match.profile.lastName}`;

                            matchesHtml += `
                            <div class="mentor-card" data-mentor-id="${match.user_id}" data-mentor-name="${mentorName}">
                                <div class="mentor-card-header">
                                    <h5 class="mb-0">Match #${index + 1}: ${mentorName}</h5>
                                    <span class="badge bg-primary">Score: ${match.score.toFixed(2)}</span>
                                </div>
                                <div class="mentor-card-body">
                                    <div class="row mentor-info">
                                        <div class="col-md-6">
                                            <p><strong>Location:</strong> ${match.profile.stateProvince || ''}, ${match.profile.country || ''}</p>
                                            <p><strong>School District:</strong> ${match.profile.schoolDistrict || 'N/A'}</p>
                                            <p><strong>Primary Subject:</strong> ${match.profile.primarySubject || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Email:</strong> ${match.email}</p>
                                            <p><strong>Phone:</strong> ${match.profile.phoneNumber || 'N/A'}</p>
                                            <p><strong>Time Zone:</strong> ${match.profile.timeZone || 'N/A'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <p><strong>Mentor Skills:</strong> ${match.profile.mentorSkills || 'No skills information available'}</p>
                                    </div>
                                    
                                    <div class="mb-0">
                                        <span class="mentor-details-toggle" onclick="toggleMentorDetails(this)">Show Full Profile</span>
                                        <div class="mentor-details">
                                            <pre>${syntaxHighlight(match.profile)}</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="mentor-card-footer">
                                    <button class="btn btn-success feedback-btn" onclick="saveFeedback('${menteeId}', '${menteeName}', '${match.user_id}', '${mentorName}', 'good', ${JSON.stringify(queryData).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-thumbs-up"></i> Good Match
                                    </button>
                                    <button class="btn btn-danger feedback-btn" onclick="saveFeedback('${menteeId}', '${menteeName}', '${match.user_id}', '${mentorName}', 'bad', ${JSON.stringify(queryData).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-thumbs-down"></i> Bad Match
                                    </button>
                                </div>
                            </div>
                        `;
                        });

                        mentorMatches.innerHTML = matchesHtml;
                    } else {
                        mentorMatches.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    mentorMatches.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        });

        // Toggle mentor details
        function toggleMentorDetails(element) {
            const detailsDiv = element.nextElementSibling;
            if (detailsDiv.style.display === 'block') {
                detailsDiv.style.display = 'none';
                element.textContent = 'Show Full Profile';
            } else {
                detailsDiv.style.display = 'block';
                element.textContent = 'Hide Full Profile';
            }
        }

        // Save feedback
        function saveFeedback(menteeId, menteeName, mentorId, mentorName, feedback, query) {
            // Disable all feedback buttons for this mentor
            const mentorCard = document.querySelector(`.mentor-card[data-mentor-id="${mentorId}"]`);
            const feedbackButtons = mentorCard.querySelectorAll('.feedback-btn');
            feedbackButtons.forEach(btn => btn.disabled = true);

            // Show loading state
            mentorCard.querySelector('.mentor-card-footer').innerHTML += '<div class="mt-2 text-center w-100">Saving feedback...</div>';

            // Save feedback
            fetch('/admin/test-matching/save-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    menteeId: menteeId,
                    menteeName: menteeName,
                    mentorId: mentorId,
                    mentorName: mentorName,
                    feedback: feedback,
                    query: query
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI to show feedback was saved
                        mentorCard.querySelector('.mentor-card-footer').innerHTML = `
                        <div class="alert alert-${feedback === 'good' ? 'success' : 'danger'} mb-0 w-100 text-center">
                            Feedback saved: <strong>${feedback === 'good' ? 'Good Match' : 'Bad Match'}</strong>
                        </div>
                    `;

                        // Add a class to the card to indicate feedback type
                        mentorCard.classList.add(feedback === 'good' ? 'border-success' : 'border-danger');
                    } else {
                        // Show error
                        mentorCard.querySelector('.mentor-card-footer').innerHTML = `
                        <div class="alert alert-danger mb-0 w-100 text-center">
                            Error saving feedback: ${data.error}
                        </div>
                    `;

                        // Re-enable buttons
                        setTimeout(() => {
                            mentorCard.querySelector('.mentor-card-footer').innerHTML = `
                            <button class="btn btn-success feedback-btn" onclick="saveFeedback('${menteeId}', '${menteeName}', '${mentorId}', '${mentorName}', 'good', ${JSON.stringify(query).replace(/"/g, '&quot;')})">
                                <i class="fas fa-thumbs-up"></i> Good Match
                            </button>
                            <button class="btn btn-danger feedback-btn" onclick="saveFeedback('${menteeId}', '${menteeName}', '${mentorId}', '${mentorName}', 'bad', ${JSON.stringify(query).replace(/"/g, '&quot;')})">
                                <i class="fas fa-thumbs-down"></i> Bad Match
                            </button>
                        `;
                        }, 3000);
                    }
                })
                .catch(error => {
                    // Show error
                    mentorCard.querySelector('.mentor-card-footer').innerHTML = `
                    <div class="alert alert-danger mb-0 w-100 text-center">
                        Error: ${error.message}
                    </div>
                `;

                    // Re-enable buttons after a delay
                    setTimeout(() => {
                        mentorCard.querySelector('.mentor-card-footer').innerHTML = `
                        <button class="btn btn-success feedback-btn" onclick="saveFeedback('${menteeId}', '${menteeName}', '${mentorId}', '${mentorName}', 'good', ${JSON.stringify(query).replace(/"/g, '&quot;')})">
                            <i class="fas fa-thumbs-up"></i> Good Match
                        </button>
                        <button class="btn btn-danger feedback-btn" onclick="saveFeedback('${menteeId}', '${menteeName}', '${mentorId}', '${mentorName}', 'bad', ${JSON.stringify(query).replace(/"/g, '&quot;')})">
                            <i class="fas fa-thumbs-down"></i> Bad Match
                        </button>
                    `;
                    }, 3000);
                });
        }

        // Load human test results
        function loadHumanTestResults() {
            const resultsDiv = document.getElementById('humanTestResults');

            fetch('/admin/test-matching/get-feedback-results')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.results.length === 0) {
                            resultsDiv.innerHTML = '<p class="text-muted">No human test results available yet.</p>';
                            return;
                        }

                        const summary = data.summary;
                        const menteeStats = data.menteeStats;

                        let resultsHtml = `
                            <div class="alert alert-${summary.goodPercentage >= 70 ? 'success' : 'warning'}">
                                <h5 class="mb-0">Overall Results</h5>
                                <p class="mb-0">Total matches rated: ${summary.total}</p>
                                <p class="mb-0">Good matches: ${summary.good} (${summary.goodPercentage.toFixed(1)}%)</p>
                                <p class="mb-0">Bad matches: ${summary.bad} (${(100 - summary.goodPercentage).toFixed(1)}%)</p>
                            </div>
                            
                            <h5 class="mt-4">Results by Mentee</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Mentee</th>
                                            <th>Total Ratings</th>
                                            <th>Good Matches</th>
                                            <th>Bad Matches</th>
                                            <th>Good Match %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        menteeStats.forEach(mentee => {
                            resultsHtml += `
                                <tr>
                                    <td>${mentee.name}</td>
                                    <td>${mentee.total}</td>
                                    <td>${mentee.good}</td>
                                    <td>${mentee.bad}</td>
                                    <td>${mentee.goodPercentage.toFixed(1)}%</td>
                                </tr>
                            `;
                        });

                        resultsHtml += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <h5 class="mt-4">Recent Feedback</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Mentee</th>
                                            <th>Mentor</th>
                                            <th>Feedback</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        // Show the 10 most recent results
                        const recentResults = [...data.results].reverse().slice(0, 10);
                        recentResults.forEach(result => {
                            const timestamp = new Date(result.timestamp).toLocaleString();
                            resultsHtml += `
                                <tr>
                                    <td>${timestamp}</td>
                                    <td>${result.menteeName}</td>
                                    <td>${result.mentorName}</td>
                                    <td>
                                        <span class="badge bg-${result.feedback === 'good' ? 'success' : 'danger'}">
                                            ${result.feedback === 'good' ? 'Good Match' : 'Bad Match'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });

                        resultsHtml += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-primary" onclick="loadHumanTestResults()">Refresh Results</button>
                            </div>
                        `;

                        resultsDiv.innerHTML = resultsHtml;
                    } else {
                        resultsDiv.innerHTML = `<div class="alert alert-danger">Error loading results: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        }
    </script>
{% endblock %}
