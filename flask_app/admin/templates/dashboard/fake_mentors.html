{% extends "base.html" %}

{% block title %}Fake Mentor Generator{% endblock %}

{% block content %}
    <style>
        .card {
            margin-bottom: 20px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .json-key {
            color: #7d3c98;
        }
        .json-string {
            color: #2e86c1;
        }
        .json-number {
            color: #e67e22;
        }
        .json-boolean {
            color: #c0392b;
        }
        .json-null {
            color: #95a5a6;
        }
    </style>

    <div class="container-fluid">
        <h1>Fake Mentor Generator</h1>
        <p>Current mentor count: <span id="mentorCount" class="badge bg-primary">{{ mentor_count }}</span></p>
        
        <div class="row">
            <!-- Import Mentors from JSON -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Import Mentors from JSON</h5>
                    </div>
                    <div class="card-body">
                        <form id="importForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="jsonFile" class="form-label">JSON/JSONL File</label>
                                <input type="file" class="form-control" id="jsonFile" name="file" accept=".json,.jsonl">
                                <div class="form-text">Upload a JSON or JSONL file containing mentor profiles</div>
                            </div>
                            <div class="mb-3">
                                <label for="numProfiles" class="form-label">Number of Profiles to Import</label>
                                <input type="number" class="form-control" id="numProfiles" name="numProfiles" min="1" max="100" value="10">
                            </div>
                            <button type="submit" class="btn btn-primary" id="importButton">Import Mentors</button>
                        </form>
                        <div id="importResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Generate Fake Mentors -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Generate Fake Mentors</h5>
                    </div>
                    <div class="card-body">
                        <form id="generateForm">
                            <div class="mb-3">
                                <label for="genNumProfiles" class="form-label">Number of Profiles to Generate</label>
                                <input type="number" class="form-control" id="genNumProfiles" name="numProfiles" min="1" max="100" value="10">
                            </div>
                            <button type="submit" class="btn btn-primary" id="generateButton">Generate Mentors</button>
                        </form>
                        <div id="generateProgress" class="progress mt-3 d-none">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="generateResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Export Mentors -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>Export Mentors</h5>
            </div>
            <div class="card-body">
                <button id="exportBtn" class="btn btn-secondary">Export All Mentors as JSON</button>
                <div id="exportResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        // Format JSON with syntax highlighting
        function syntaxHighlight(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Function to update mentor count
        function updateMentorCount() {
            fetch('/admin/fake-mentors/count')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('mentorCount').textContent = data.count;
                    }
                })
                .catch(error => console.error('Error updating mentor count:', error));
        }

        // Import Mentors Form
        document.getElementById('importForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const numProfiles = parseInt(document.getElementById('numProfiles').value);
            const importButton = document.getElementById('importButton');
            const mentorCountBadge = document.getElementById('mentorCount');
            
            // Disable button and change mentor count badge to yellow (in progress)
            importButton.disabled = true;
            mentorCountBadge.classList.remove('bg-primary');
            mentorCountBadge.classList.add('bg-warning');
            
            // Get current mentor count
            fetch('/admin/fake-mentors/count')
                .then(response => response.json())
                .then(data => {
                    const startCount = data.success ? data.count : 0;
                    
                    // Start the import
                    return fetch('/admin/fake-mentors/import', {
                        method: 'POST',
                        body: formData
                    });
                })
                .then(response => response.json())
                .then(data => {
                    let resultHtml = '';
                    if (data.success) {
                        resultHtml = `<div class="alert alert-success">Successfully imported ${data.count} mentor profiles</div>`;
                        
                        // Update the mentor count and change badge to green (success)
                        fetch('/admin/fake-mentors/count')
                            .then(response => response.json())
                            .then(countData => {
                                if (countData.success) {
                                    mentorCountBadge.textContent = countData.count;
                                    mentorCountBadge.classList.remove('bg-warning');
                                    mentorCountBadge.classList.add('bg-success');
                                    
                                    // Change back to blue after 3 seconds
                                    setTimeout(() => {
                                        mentorCountBadge.classList.remove('bg-success');
                                        mentorCountBadge.classList.add('bg-primary');
                                    }, 3000);
                                }
                            });
                    } else {
                        resultHtml = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        // Change badge back to blue
                        mentorCountBadge.classList.remove('bg-warning');
                        mentorCountBadge.classList.add('bg-primary');
                    }
                    document.getElementById('importResult').innerHTML = resultHtml;
                    importButton.disabled = false;
                })
                .catch(error => {
                    document.getElementById('importResult').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                    // Change badge back to blue
                    mentorCountBadge.classList.remove('bg-warning');
                    mentorCountBadge.classList.add('bg-primary');
                    importButton.disabled = false;
                });
        });

        // Update mentor count when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateMentorCount();
        });
        
        // Generate Mentors Form
        document.getElementById('generateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const generateButton = document.getElementById('generateButton');
            const progressBar = document.getElementById('generateProgress');
            const progressBarInner = progressBar.querySelector('.progress-bar');
            const resultDiv = document.getElementById('generateResult');
            
            // Disable button and show progress bar
            generateButton.disabled = true;
            progressBar.classList.remove('d-none');
            progressBarInner.style.width = '0%';
            resultDiv.innerHTML = '<div class="alert alert-info">Starting generation...</div>';
            
            // Start the generation
            fetch('/admin/fake-mentors/generate', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Poll for progress
                    const pollInterval = setInterval(() => {
                        fetch('/admin/fake-mentors/progress')
                            .then(response => response.json())
                            .then(progressData => {
                                if (progressData.success) {
                                    const percent = (progressData.current / progressData.total) * 100;
                                    progressBarInner.style.width = `${percent}%`;
                                    
                                    if (!progressData.in_progress) {
                                        clearInterval(pollInterval);
                                        progressBar.classList.add('d-none');
                                        generateButton.disabled = false;
                                        
                                        if (progressData.error) {
                                            resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${progressData.error}</div>`;
                                        } else {
                                            resultDiv.innerHTML = `<div class="alert alert-success">Successfully generated ${progressData.total} mentor profiles</div>`;
                                            updateMentorCount();
                                        }
                                    }
                                }
                            })
                            .catch(error => {
                                clearInterval(pollInterval);
                                progressBar.classList.add('d-none');
                                generateButton.disabled = false;
                                resultDiv.innerHTML = `<div class="alert alert-danger">Error checking progress: ${error.message}</div>`;
                            });
                    }, 1000);
                } else {
                    progressBar.classList.add('d-none');
                    generateButton.disabled = false;
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                progressBar.classList.add('d-none');
                generateButton.disabled = false;
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
        });

        // Export Mentors Button
        document.getElementById('exportBtn').addEventListener('click', function() {
            fetch('/admin/fake-mentors/export-json')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create a download link for the JSON data
                    const blob = new Blob([JSON.stringify(data.mentors, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mentors_export.json';
                    a.textContent = 'Download JSON';
                    a.className = 'btn btn-primary mt-2';
                    
                    const resultDiv = document.getElementById('exportResult');
                    resultDiv.innerHTML = `<div class="alert alert-success">Successfully exported ${data.total} mentors</div>`;
                    resultDiv.appendChild(a);
                } else {
                    document.getElementById('exportResult').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('exportResult').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
        });
    </script>
{% endblock %}
